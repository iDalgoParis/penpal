!function(e,n){var t={};!function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.ERR_IFRAME_ALREADY_ATTACHED_TO_DOM=e.ERR_NOT_IN_IFRAME=e.ERR_CONNECTION_TIMEOUT=e.ERR_CONNECTION_DESTROYED=void 0;e.ERR_CONNECTION_DESTROYED="ConnectionDestroyed";e.ERR_CONNECTION_TIMEOUT="ConnectionTimeout";e.ERR_NOT_IN_IFRAME="NotInIframe";e.ERR_IFRAME_ALREADY_ATTACHED_TO_DOM="IframeAlreadyAttachedToDom";var n={"http:":"80","https:":"443"},t=/^(https?:|file:)?\/\/([^\/:]+)?(:(\d+))?/,o={ERR_CONNECTION_DESTROYED:"ConnectionDestroyed",ERR_CONNECTION_TIMEOUT:"ConnectionTimeout",ERR_NOT_IN_IFRAME:"NotInIframe",ERR_IFRAME_ALREADY_ATTACHED_TO_DOM:"IframeAlreadyAttachedToDom",Promise:function(){try{return window?window.Promise:null}catch(e){return null}}(),debug:!1},r=(s=0,function(){return"iDalgoIframe-".concat(++s)}),a=function(){if(o.debug){for(var e,n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];(e=console).log.apply(e,["[Penpal]"].concat(t))}},i=function(e){var n=[];return e(function(){n.forEach(function(e){e()})}),{then:function(e){n.push(e)}}},c=function(e){var n=e.name,t=e.message,o=e.stack;return{name:n,message:t,stack:o}},d=function(e,n,t,i,c){var d=n.localName,l=n.local,s=n.remote,u=n.remoteOrigin,m=!1;a("".concat(d,": Connecting call sender"));var f=function(e){return function(){for(var n=arguments.length,t=new Array(n),c=0;c<n;c++)t[c]=arguments[c];if(a("".concat(d,": Sending ").concat(e,"() call")),s.closed&&i(),m){var f=new Error("Unable to send ".concat(e,"() call due ")+"to destroyed connection");throw f.code="ConnectionDestroyed",f}return new o.Promise(function(n,o){var i=r();l.addEventListener("message",function t(r){if(r.source===s&&r.origin===u&&"reply"===r.data.penpal&&r.data.id===i){a("".concat(d,": Received ").concat(e,"() reply")),l.removeEventListener("message",t);var c=r.data.returnValue;r.data.returnValueIsError&&(m=c,f=new Error,Object.keys(m).forEach(function(e){return f[e]=m[e]}),c=f),("fulfilled"===r.data.resolution?n:o)(c)}var m,f}),s.postMessage({penpal:"call",id:i,methodName:e,args:t},u)})}};c.then(function(){m=!0}),t.reduce(function(e,n){return e[n]=f(n),e},e)},l=function(e,n,t){var r=e.localName,i=e.local,d=e.remote,l=e.remoteOrigin,s=!1;a("".concat(r,": Connecting call receiver"));var u=function(e){if(e.source===d&&e.origin===l&&"call"===e.data.penpal){var t=e.data,i=t.methodName,u=t.args,m=t.id;if(a("".concat(r,": Received ").concat(i,"() call")),i in n){var f=function(e){return function(n){if(a("".concat(r,": Sending ").concat(i,"() reply")),s)a("".concat(r,": Unable to send ").concat(i,"() reply due to destroyed connection"));else{var t={penpal:"reply",id:m,resolution:e,returnValue:n};"rejected"===e&&n instanceof Error&&(t.returnValue=c(n),t.returnValueIsError=!0);try{d.postMessage(t,l)}catch(e){throw"DataCloneError"===e.name&&d.postMessage({penpal:"reply",id:m,resolution:"rejected",returnValue:c(e),returnValueIsError:!0},l),e}}}};new o.Promise(function(e){return e(n[i].apply(n,u))}).then(f("fulfilled"),f("rejected"))}}};i.addEventListener("message",u),t.then(function(){s=!0,i.removeEventListener("message",u)})};var s;o.connectToChild=function(e){var r,c=e.url,s=e.appendTo,u=e.iframe,m=e.methods,f=void 0===m?{}:m,v=e.timeout;if(u&&u.parentNode){var E=new Error("connectToChild() must not be called with an iframe already attached to DOM");throw E.code="IframeAlreadyAttachedToDom",E}var h=new i(function(e){r=e}),p=window;(u=u||document.createElement("iframe")).src=c,u.scrolling="no",u.frameBorder=0,u.style.height=0,u.style.width="100%",u.style.maxWidth="100vw !important";var g=function(e){var o,r,a,i=document.location,c=t.exec(e);c?(o=c[1]?c[1]:i.protocol,r=c[2],a=c[4]):(o=i.protocol,r=i.hostname,a=i.port);if("file:"===o)return"null";var d=a&&a!==n[o]?":".concat(a):"";return"".concat(o,"//").concat(r).concat(d)}(c),T=new o.Promise(function(e,n){var t;void 0!==v&&(t=setTimeout(function(){var e=new Error("Connection to child timed out after ".concat(v,"ms"));e.code="ConnectionTimeout",n(e),r()},v));var o,c,m={},E=function(n){var s=u.contentWindow;if(n.source===s&&n.origin===g&&"handshake"===n.data.penpal){a("Parent: Received handshake, sending reply");var v="null"===n.origin?"*":n.origin;n.source.postMessage({penpal:"handshake-reply",methodNames:Object.keys(f)},v);var E={localName:"Parent",local:p,remote:s,remoteOrigin:v};c&&c();var T=new i(function(e){h.then(e),c=e});l(E,f,T),o&&o.forEach(function(e){delete m[e]}),o=n.data.methodNames,d(m,E,o,r,h),clearTimeout(t),e(m)}};p.addEventListener("message",E),a("Parent: Loading iframe"),s.parentNode.insertBefore(u,s);var T=setInterval(function(){document.contains(u)||(clearInterval(T),r())},6e4);h.then(function(){u.parentNode&&u.parentNode.removeChild(u),p.removeEventListener("message",E),clearInterval(T);var e=new Error("Connection destroyed");e.code="ConnectionDestroyed",n(e)})});return{promise:T,iframe:u,destroy:r}},o.connectToParent=function(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=n.parentOrigin,r=void 0===t?"*":t,c=n.methods,s=void 0===c?{}:c,u=n.timeout;if(window===window.top){var m=new Error("connectToParent() must be called within an iframe");throw m.code="NotInIframe",m}var f=new i(function(n){e=n}),v=window,E=v.parent,h=new o.Promise(function(n,t){var o;void 0!==u&&(o=setTimeout(function(){var n=new Error("Connection to parent timed out after ".concat(u,"ms"));n.code="ConnectionTimeout",t(n),e()},u));var i=function t(i){if(("*"===r||r===i.origin)&&i.source===E&&"handshake-reply"===i.data.penpal){a("Child: Received handshake reply"),v.removeEventListener("message",t);var c={localName:"Child",local:v,remote:E,remoteOrigin:i.origin},u={};l(c,s,f),d(u,c,i.data.methodNames,e,f),clearTimeout(o),n(u)}};v.addEventListener("message",i),f.then(function(){v.removeEventListener("message",i);var e=new Error("Connection destroyed");e.code="ConnectionDestroyed",t(e)}),a("Child: Sending handshake"),E.postMessage({penpal:"handshake",methodNames:Object.keys(s)},r)});return{promise:h,destroy:e}};var u=o;e.default=u}(t),"function"==typeof define&&define.amd?define("Penpal",t.default):e.Penpal=t.default}(this);